---
lab:
  title: 演習 - 悪意のあるトラフィックから Web アプリケーションを保護し、承認されていないアクセスをブロックする
  module: Guided Project - Configure secure access to workloads with Azure virtual networking services
---

# 課題: 悪意のあるトラフィックから Web アプリケーションを保護し、承認されていないアクセスをブロックする


## シナリオ
あなたの組織は、悪意のあるトラフィックから Web アプリケーションを保護し、承認されていないアクセスをブロックすることを検討しています。

NSG と ASG に加えてファイアウォールを構成することで、Web アプリケーションにさらにセキュリティ レイヤーを追加できます。 ファイアウォールで、構成したポリシーを使って悪意のあるトラフィックから Web アプリケーションを保護し、不正なアクセスをブロックします。

Azure Firewall ポリシーは、Azure Firewall のセキュリティと運用の設定を含むトップレベルのリソースです。 これを使って規則の階層を定義し、コンプライアンスを適用することができます。 このタスクでは、ファイアウォール ポリシーを使ってファイアウォールのアプリケーション規則とネットワーク規則を構成します。 Azure Firewall ポリシーを使って、Azure Firewall がトラフィックのフィルター処理に使うルール セットを管理できます。 

### アーキテクチャの図

![ファイアウォールとルート テーブルがある 1 つの仮想ネットワークを示す図。](../Media/task-3.png)

### スキル タスク
- Azure ファイアウォールを作成する。
- ファイアウォール ポリシーを作成して構成する
- アプリケーション規則コレクションを作成する。
- ネットワーク規則コレクションを作成する。
  
## 演習の手順

### 既存の仮想ネットワークに Azure Firewall サブネットを作成する

1. ポータルの上部にある検索ボックスに、「仮想ネットワーク」と入力します。 検索結果で、**[仮想ネットワーク]** を選択します。

1. **app-vnet** を選択します。

1. **[サブネット]** を選択します。

1. **[+ サブネット]** を選択します。

1. 次の情報を入力して、**追加**を選択します。

    | プロパティ | 値    |
    |:---------|:---------|
    |サブネットの目的      | **Azure Firewall**|
    |アドレス範囲| **10.1.2.0/26**|

    > **注**: その他の設定は、すべて既定のままにしておきます。
    

### Azure Firewall を作成する

1. ポータルの上部にある検索ボックスに、「**Firewall**」と入力します。 検索結果で **[ファイアウォール]** を選択します。

1. **[+ 作成]** を選択します。

1.  次の表の値を使ってファイアウォールを作成します。 指定されていないプロパティには、既定値を使います。
    >**注**: Azure Firewall のデプロイには数分かかる場合があります。

    | プロパティ | 値    |
    |:---------|:---------|
    |Resource group   | **(既存のRG1で始まるリソースグループ)**  |
    |名前      | **app-vnet-firewall**|
    |ファイアウォール SKU | **Standard**|
    |ファイアウォール管理 | **ファイアウォール ポリシーを使用してこのファイアウォールを管理する**|
    |ファイアウォール ポリシー| **[]** を選びます| 
    |ポリシー名| **fw-policy**|
    |リージョン| **米国東部**|
    |ポリシー レベル| **Standard**|
    |仮想ネットワークの選択 | **[既存のものを使用]**|
    |仮想ネットワーク | **app-vnet** (RG1)|
    |パブリック IP アドレス | 新規追加: **fwpip**|

    [ファイアウォールの作成に関する詳細情報](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal)。

1. **[確認および作成]** を選択し、次に **[作成]** を選択します。

### ファイアウォール ポリシーを更新する

1. ポータルの上部にある検索ボックスに、「**ファイアウォール ポリシー**」と入力します。 検索結果で **[ファイアウォール ポリシー]** を選択します。

1. **fw-policy** を選択します。

1. **[Application rules]  (アプリケーション 規則)** を選択します。

1. **[+ 規則 コレクションの追加]** を選択します。

1. 次の表の値を使います。 指定されていないプロパティには、既定値を使います。

    |プロパティ|  値 |
    |:---------|:---------|
    |名前   |**app-vnet-fw-rule-collection**|
    |規則コレクションの種類| **アプリケーション**|
    |優先度|  **200**|
    |規則コレクション アクション|**許可**|
    |規則コレクション グループ| **DefaultApplicationRuleCollectionGroup**|

    1. **[ルール]** に次の表の値を使い、

        |プロパティ|  値 |
        |:---------|:---------|
        |名前   |**AllowAzurePipelines**|
        |変換元の型|**IP アドレス (IP address)**|
        |ソース|**10.1.0.0/23**|
        |Protocol|**https** |
        |変換先の型|FQDN|
        |宛先|**dev.azure.com, azure.microsoft.com**|

        **[追加]** を選択します

> **注**: **AllowAzurePipelines** ルールを使用すると、Web アプリケーションは Azure Pipelines にアクセスできます。 このルールにより、Web アプリケーションは Azure DevOps サービスと Azure Web サイトにアクセスできます。


1. **[ネットワーク 規則]** を選択します。

1. **[+ 規則コレクションの追加]** を選択します。

1. 次の表の値を使います。 指定されていないプロパティには、既定値を使います。

    |プロパティ|  値|
    |:---------|:---------|
    |名前|  **app-vnet-fw-nrc-dns**|
    |規則コレクションの種類| **ネットワーク**|
    |優先度|  **200**|
    |規則コレクション アクション|**許可**|
    |規則コレクション グループ| **DefaultNetworkRuleCollectionGroup**|

    1. **[ルール]** に次の表の値を使い、

        |プロパティ|  値|
        |:---------|:---------|
        |Rule | **AllowDns**|
        |ソース|    **10.1.0.0/23**|
        |Protocol|  **UDP**|
        |送信先ポート| **53**|
        |送信先アドレス| **1.1.1.1, 1.0.0.1**|

        そして **[追加]** を選択します。


    詳細については、[アプリケーション規則の作成](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal#configure-an-application-rule)と[ネットワーク規則の作成](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal#configure-a-network-rule)に関する記事を参照してください。

1. Azure Firewall とファイアウォール ポリシーのプロビジョニングの状態が「**成功**」と表示されていることを確認します。

ポータルの上部にある検索ボックスに、「**ファイアウォール**」と入力します。 検索結果で **[ファイアウォール]** を選択します。

1. **[vnet-firewall]** を選択します。

**プロビジョニングの状態**が「**成功**」であることを確認します。

ポータルの上部にある検索ボックスに、「**ファイアウォール ポリシー**」と入力します。 検索結果で **[ファイアウォール ポリシー]** を選択します。

1. **fw-policy** を選択します。

**プロビジョニングの状態**が「**成功**」であることを確認します。

