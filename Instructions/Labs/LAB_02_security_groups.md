---
lab:
  title: '演習: Web アプリケーションとの間のネットワーク トラフィックを制御する'
  module: Guided Project - Configure secure access to workloads with Azure virtual networking services
---

# ラボ: Web アプリケーションとの間のネットワーク トラフィックを制御する

## シナリオ

あなたの組織では、Web アプリケーションとの間のネットワーク トラフィックを制御する必要があります。 Web アプリケーションのセキュリティをさらに強化するようにネットワーク セキュリティ グループ (NSG) とアプリケーション セキュリティ グループ (ASG) を構成することができます。 NSG は Azure リソースとの間のネットワーク トラフィックをフィルター処理するセキュリティ レイヤーです。一方、ASG を使うと、リソースをグループ化してまとめて管理できます。 これらのセキュリティ グループを使って、Web アプリケーション コンポーネントとの間のネットワーク トラフィックをきめ細かく制御できます。

### アーキテクチャの図

![仮想ネットワークに関連付けられた 1 つの ASG と NSG を示す図。](../Media/task-2.png)

### スキル タスク

- NSG を作成する。
- NSG 規則を作成する。
- NSG をサブネットに関連付ける。
- NSG 規則でアプリケーション セキュリティ グループを作成して使う。

## 演習の手順

### アプリケーション セキュリティ グループを作成する

アプリケーション セキュリティ グループ (ASG) を使用すると、Web サーバーなど、同様の機能を持つサーバーをグループ化できます。

1. ポータルの上部にある検索ボックスに、「アプリケーションのセキュリティ グループ」と入力します。検索結果から** [アプリケーションのセキュリティ グループ] ** を選びます。

1. **[+ 作成]** を選択します。

    [アプリケーション セキュリティ グループの作成] の **[基本]** タブで、次の表に示すように情報を入力します。

    | プロパティ | 値    |
    |:---------|:---------|
    |サブスクリプション|**サブスクリプションを選択します**|
    |Resource group|**(既存のRG1で始まるリソースグループ)**|
    |名前|**app-backend-asg**|
    |リージョン|**米国東部**|

1. **[確認および作成]** を選択し、次に **[作成]** を選択します。

[詳しくは、「アプリケーション セキュリティ グループの作成」を参照してください](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic#create-application-security-groups)。

>**注**: 既存の仮想ネットワークと同じリージョンにアプリケーション セキュリティ グループを作成しています。

### ネットワーク セキュリティ グループを作成して関連付けます。

ネットワーク セキュリティ グループ (NSG) は、仮想ネットワーク内のネットワーク トラフィックをセキュリティで保護するものです。 NSG には、Azure 仮想ネットワーク (VNET) に接続されたリソースへのネットワーク トラフィックを許可または拒否する一連のセキュリティ規則が含まれています。 NSG は、サブネットや Azure Virtual Machines (VM)  に接続された個々のネットワーク インターフェイスに関連付けることができます。

1. ポータルの上部にある検索ボックスに、「ネットワーク セキュリティ グループ」と入力します。 検索結果から **[ネットワーク セキュリティ グループ]** を選択します。

1. **[+ 作成]** を選択します。

    [ネットワーク セキュリティ グループの作成] の **[基本 ]** タブで、次の表に示すように情報を入力します。

    | プロパティ | 値    |
    |:---------|:---------|
    |サブスクリプション|**サブスクリプションを選択します**|
    |Resource group|**(既存のRG1で始まるリソースグループ)**|
    |名前|**app-vnet-nsg**|
    |リージョン|**米国東部**|

    [詳細については、ネットワーク セキュリティ グループの作成に関する記事を参照してください](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic#create-a-network-security-group)。

1. **[確認および作成]** を選択し、次に **[作成]** を選択します。

このセクションでは、先ほど作成した仮想ネットワークのサブネットにネットワーク セキュリティ グループを関連付けます。

1. ポータルの上部にある検索ボックスに、「ネットワーク セキュリティ グループ」と入力します。 検索結果から **[ネットワーク セキュリティ グループ]** を選択します。

1. ネットワーク セキュリティ グループの一覧で、**[app-vnet-nsg]** を選択します。

1. **app-vnet-nsg** の「設定」セクションから **[サブネット]** を選択します。

1. サブネットページで **[+ 関連付け]** を選択します。

1. **サブネットの関連付け**で仮想ネットワークとして **[vnet-1 (test-rg)]** を選択します。 サブネットとして **[backend]** を選択し、[OK] を選択します。

    [ネットワーク セキュリティ グループをサブネットに関連付ける方法について説明します](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic#associate-a-network-security-group-to-a-subnet)。

### ネットワーク セキュリティ グループ規則を作成する
ネットワーク セキュリティ グループ (NSG) は、仮想ネットワーク内のネットワーク トラフィックをセキュリティで保護するものです。

1. ポータルの上部にある検索ボックスに、「ネットワーク セキュリティ グループ」と入力します。**** 検索結果から [ネットワーク セキュリティ グループ] を選択します。

1. ネットワーク セキュリティ グループの一覧で、**[myVM-nsg]** を選択します。

1. **app-vnet-nsg** の「設定」セクションから **[受信セキュリティ規則]** を選択します。

1. **[+ 追加]** を選択します。

1. **受信セキュリティ規則の追加**ページで、次の表に示すように情報を入力します。

    | プロパティ | 値    |
    |:---------|:---------|
    |ソース|**[Any]**|
    |ソース ポート範囲|**\***|
    |宛先|**Application security group**|
    |宛先アプリケーションのセキュリティ グループ|**app-backend-asg**|    
    |Service|**SSH**|
    |アクション|**許可**|
    |優先度|**100**|
    |名前|**AllowSSH**|

    [詳細については、ネットワーク セキュリティ グループ規則の作成に関する記事を参照してください](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic#create-a-network-security-group)。

### Cloud Shell を使用して ARM テンプレートをデプロイし、この演習に必要な VM を作成する

1. Azure portal の右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** または **PowerShell** の選択を求めるメッセージが表示されたら、 **[PowerShell]** を選択します。

    >**注**: **Cloud Shell** を初めて起動し、[**ストレージがマウントされていません**] というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、**[ストレージの作成]** を選択します。

1. Cloud Shell を使用して次の ARM テンプレートをデプロイして、この演習に必要な VM を作成します。

>**注**: 下のセクションでテキストを選択し、Cloud Shell にコピーまたは貼り付けることができます。

   ```powershell
   $RGName = $(Get-AzResourceGroup -name "RG1*").resourcegroupname 
   
   New-AzResourceGroupDeployment -ResourceGroupName $RGName -TemplateUri https://raw.githubusercontent.com/MicrosoftLearning/Configure-secure-access-to-workloads-with-Azure-virtual-networking-services/main/Instructions/Labs/azuredeploy.json
   ```
  
1. **VM1** と **VM2** の両方の仮想マシンが実行されていることを確認するには、**RG1 リソース グループ**に移動し、**VM1** を選択します。

1. 仮想マシンの状態が**実行中**であることを確認します。

1. **VM2** について前の手順を繰り返します。

### アプリケーション セキュリティ グループを VM のネットワーク インターフェイスに関連付ける
VM を作成したとき、Azure では各 VM 用のネットワーク インターフェイスが作成され、それが VM に接続されました。

VM2 用のネットワーク インターフェイスを、前に作成したアプリケーション セキュリティ グループに追加します。

1. Azure portal で **RG1** リソース グループに移動し、**[VM2]** を選択します。

1. VM の [ネットワーク] タブに移動し、「**アプリケーション セキュリティ グループ**」セクションから **[+ アプリケーション セキュリティ グループの追加]** を選択します。 

1. アプリケーション セキュリティ グループの一覧から　**app-backend-asg** を選択します。

1. **[追加]** を選択します。

  [アプリケーション セキュリティ グループに NIC を追加する方法の詳細について説明します](https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface?tabs=azure-portal#add-or-remove-from-application-security-groups)。

